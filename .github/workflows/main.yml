name: Deploy Next.js (Velite) to VPS with PM2

on:
  #push:
    #branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录，便于 Velite 比较变化

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # 遇到错误立即退出

            echo "🚀 开始部署 Next.js 应用..."
            
            cd /opt/1panel/runtime/next/sai

            echo "=== 1. 停止并清理旧的 PM2 服务 ==="
            pm2 stop all --silent || true
            pm2 delete all --silent || true

            echo "=== 2. 拉取最新代码 ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== 3. 检查是否有 package.json 变更 ==="
            if git diff --name-only HEAD~1 HEAD | grep -q "package.json\|package-lock.json"; then
              echo "📦 检测到依赖变更，清理缓存..."
              rm -rf .next node_modules
            else
              echo "📦 依赖未变更，跳过清理..."
            fi

            echo "=== 4. 安装依赖 ==="
            npm ci --prefer-offline --no-audit

            echo "=== 5. 构建项目 ==="
            echo "🔨 Velite 构建中..."
            npm run build

            echo "=== 6. 启动 PM2 服务 ==="
            # 检查是否已存在 sai 应用
            if pm2 list | grep -q "sai"; then
              echo "🔄 重启现有应用..."
              pm2 restart sai --update-env
            else
              echo "🆕 创建新应用..."
              pm2 start npm --name "sai" -- run start
            fi

            echo "=== 7. 配置 PM2 开机自启 ==="
            pm2 save --force
            pm2 startup | tail -1 | sh 2>/dev/null || true

            echo "=== 8. 最终状态检查 ==="
            echo "📊 应用状态:"
            pm2 list

            echo "✅ 部署完成！PM2 已成功托管 sai 服务"
            echo "🌐 应用运行在: http://localhost:3888"