name: Deploy Next.js (Velite) to VPS with PM2

on:
  #push:
    #branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä¾¿äº Velite æ¯”è¾ƒå˜åŒ–

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

            echo "ğŸš€ å¼€å§‹éƒ¨ç½² Next.js åº”ç”¨..."
            
            cd /opt/1panel/runtime/next/sai

            echo "=== 1. åœæ­¢å¹¶æ¸…ç†æ—§çš„ PM2 æœåŠ¡ ==="
            pm2 stop all --silent || true
            pm2 delete all --silent || true

            echo "=== 2. æ‹‰å–æœ€æ–°ä»£ç  ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== 3. æ£€æŸ¥æ˜¯å¦æœ‰ package.json å˜æ›´ ==="
            if git diff --name-only HEAD~1 HEAD | grep -q "package.json\|package-lock.json"; then
              echo "ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–å˜æ›´ï¼Œæ¸…ç†ç¼“å­˜..."
              rm -rf .next node_modules
            else
              echo "ğŸ“¦ ä¾èµ–æœªå˜æ›´ï¼Œè·³è¿‡æ¸…ç†..."
            fi

            echo "=== 4. å®‰è£…ä¾èµ– ==="
            npm ci --prefer-offline --no-audit

            echo "=== 5. æ„å»ºé¡¹ç›® ==="
            echo "ğŸ”¨ Velite æ„å»ºä¸­..."
            npm run build

            echo "=== 6. å¯åŠ¨ PM2 æœåŠ¡ ==="
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ sai åº”ç”¨
            if pm2 list | grep -q "sai"; then
              echo "ğŸ”„ é‡å¯ç°æœ‰åº”ç”¨..."
              pm2 restart sai --update-env
            else
              echo "ğŸ†• åˆ›å»ºæ–°åº”ç”¨..."
              pm2 start npm --name "sai" -- run start
            fi

            echo "=== 7. é…ç½® PM2 å¼€æœºè‡ªå¯ ==="
            pm2 save --force
            pm2 startup | tail -1 | sh 2>/dev/null || true

            echo "=== 8. æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ ==="
            echo "ğŸ“Š åº”ç”¨çŠ¶æ€:"
            pm2 list
            
            echo "ğŸ“ˆ èµ„æºä½¿ç”¨:"
            pm2 monit --silent & 
            sleep 5
            pkill pm2 || true

            echo "âœ… éƒ¨ç½²å®Œæˆï¼PM2 å·²æˆåŠŸæ‰˜ç®¡ sai æœåŠ¡"
            echo "ğŸŒ åº”ç”¨è¿è¡Œåœ¨: http://localhost:3888"